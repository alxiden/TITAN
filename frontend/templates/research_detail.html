<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>Cluster: {{ cluster.title }}</h1>
        <p class="muted">Type: {{ cluster.cluster_type.value }} ¬∑ DB: {{ db_path }}</p>
      </div>
      <div style="display:flex; gap:0.5rem; margin-left:auto;">
        <a href="/research" class="btn">üß™ Research</a>
        <a href="/" class="btn">üè† Home</a>
      </div>
    </div>
  </header>

  <main>
    <div class="container-fluid">
      <div class="row g-3">
        <div class="col-12 col-xl-8">
          <section class="info-card">
            <h2>Summary</h2>
            <ul class="links">
              <li>Timeframe: {{ cluster.time_start.strftime('%Y-%m-%d') if cluster.time_start else '-' }} ‚Üí {{ cluster.time_end.strftime('%Y-%m-%d') if cluster.time_end else '-' }}</li>
              <li>Members: Phish {{ cluster.phishing|length }}, Malware {{ cluster.malware|length }}, IOCs {{ cluster.iocs|length }}, Events {{ cluster.events|length }}</li>
              <li>Scores: Overlap {{ cluster.score or 'N/A' }}, APT Linkage {{ cluster.apt_overlap_score or 'N/A' }}</li>
            </ul>
            {% if cluster.summary %}
            <p class="muted">Rationale: {{ cluster.summary }}</p>
            {% endif %}
          </section>

          <section class="info-card mt-3">
            <h2>Attach Members</h2>
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Type</label>
                <select id="candType" class="form-select">
                  <option value="phishing">Phishing</option>
                  <option value="malware">Malware</option>
                  <option value="ioc">IOC</option>
                  <option value="event">Event</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Days</label>
                <select id="candDays" class="form-select">
                  <option value="30" selected>30</option>
                  <option value="60">60</option>
                  <option value="90">90</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Search</label>
                <input id="candQuery" type="text" class="form-control" placeholder="subject, name, domain, hash‚Ä¶">
              </div>
              <div class="col-md-12 d-flex gap-2">
                <button id="loadCands" class="btn btn-secondary">Load Candidates</button>
              </div>
            </div>
            <div class="mt-3">
              <table class="table table-dark table-striped" id="candsTable">
                <thead>
                  <tr><th>ID</th><th>Label</th><th>Meta</th><th></th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="info-card mt-3">
            <h2>Members</h2>
            <div class="row g-3">
              <div class="col-md-6">
                <h3>Phishing</h3>
                <ul>
                  {% for p in cluster.phishing %}
                    <li>#{{ p.id }} ¬∑ {{ p.subject or 'Untitled' }} ‚Äî {{ p.sender or '' }}
                      <button class="btn btn-sm btn-outline-danger" onclick="detach('phishing', {{ p.id }})">Detach</button>
                    </li>
                  {% endfor %}
                </ul>
                <h3 class="mt-3">Malware</h3>
                <ul>
                  {% for m in cluster.malware %}
                    <li>#{{ m.id }} ¬∑ {{ m.name or 'Unnamed' }} ‚Äî {{ m.family or m.category or '' }}
                      <button class="btn btn-sm btn-outline-danger" onclick="detach('malware', {{ m.id }})">Detach</button>
                    </li>
                  {% endfor %}
                </ul>
              </div>
              <div class="col-md-6">
                <h3>IOCs</h3>
                <ul>
                  {% for i in cluster.iocs %}
                    <li>#{{ i.id }} ¬∑ {{ i.type or '' }} ‚Äî {{ i.value or '' }}
                      <button class="btn btn-sm btn-outline-danger" onclick="detach('ioc', {{ i.id }})">Detach</button>
                    </li>
                  {% endfor %}
                </ul>
                <h3 class="mt-3">Events</h3>
                <ul>
                  {% for e in cluster.events %}
                    <li>#{{ e.id }} ¬∑ {{ e.title }} ‚Äî {{ e.severity or '' }}
                      <button class="btn btn-sm btn-outline-danger" onclick="detach('event', {{ e.id }})">Detach</button>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </section>
        </div>
        <aside class="col-12 col-xl-4">
          <div class="important-info">
            <h2>Quick Stats</h2>
            <div class="info-card">
              <ul class="links">
                <li>Events: {{ counts.events }}</li>
                <li>Malware: {{ counts.malware }}</li>
                <li>Phishing: {{ counts.phishing }}</li>
                <li>IOCs: {{ counts.iocs }}</li>
                <li>APTs: {{ counts.apts }}</li>
              </ul>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer>
    <p class="muted">¬© TITAN CTI Platform</p>
  </footer>

  <script>
    const clusterId = {{ cluster.id }};
    const candsTableBody = document.querySelector('#candsTable tbody');
    const loadBtn = document.getElementById('loadCands');
    const typeSel = document.getElementById('candType');
    const daysSel = document.getElementById('candDays');
    const queryInput = document.getElementById('candQuery');

    loadBtn.addEventListener('click', async () => {
      const type = typeSel.value;
      const days = daysSel.value;
      const q = queryInput.value.trim();
      const url = `/api/research/candidates?type=${encodeURIComponent(type)}&days=${encodeURIComponent(days)}${q ? `&q=${encodeURIComponent(q)}` : ''}`;
      const res = await fetch(url);
      const data = await res.json();
      candsTableBody.innerHTML = '';
      (data.items || []).forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.id}</td><td>${item.label}</td><td>${item.meta || ''}</td><td><button class=\"btn btn-sm btn-primary\" data-id=\"${item.id}\">Attach</button></td>`;
        const btn = tr.querySelector('button');
        btn.addEventListener('click', async () => {
          const fd = new FormData();
          fd.append('type', type);
          fd.append('item_id', item.id);
          const attachRes = await fetch(`/api/research/cluster/${clusterId}/attach`, { method: 'POST', body: fd });
          if (attachRes.ok) {
            btn.textContent = 'Attached';
            btn.disabled = true;
          }
        });
        candsTableBody.appendChild(tr);
      });
    });

    async function detach(type, id) {
      const fd = new FormData();
      fd.append('type', type);
      fd.append('item_id', id);
      const res = await fetch(`/api/research/cluster/${clusterId}/detach`, { method: 'POST', body: fd });
      if (res.ok) {
        // naive refresh to update lists
        window.location.reload();
      }
    }
  </script>
</body>
</html>
