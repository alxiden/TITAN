<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event #{{ event.id }} — TITAN</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <h1><a href="/">TITAN</a> / <a href="/events">Events</a> / #{{ event.id }}</h1>
  </header>

  <main>
    <div class="toolbar">
      <h2>{{ event.title }}</h2>
      <div>
        <a href="/events/{{ event.id }}/edit" class="btn">Edit</a>
        <form method="post" action="/events/{{ event.id }}/delete" style="display:inline">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this event?')">Delete</button>
        </form>
      </div>
    </div>

    <div class="detail-view">
      <div class="detail-row">
        <span class="label">Type:</span>
        <span>{% if event.type %}<span class="badge">{{ event.type.value.replace('_', ' ').title() }}</span>{% else %}—{% endif %}</span>
      </div>
      <div class="detail-row">
        <span class="label">Severity:</span>
        <span>{% if event.severity %}<span class="badge badge-{{ event.severity }}">{{ event.severity }}</span>{% else %}—{% endif %}</span>
      </div>
      <div class="detail-row">
        <span class="label">Status:</span>
        <span><span class="badge badge-{{ event.status.value }}">{{ event.status.value.replace('_', ' ').title() }}</span></span>
      </div>
      <div class="detail-row">
        <span class="label">Description:</span>
        <span>{{ event.description or '—' }}</span>
      </div>
      {% if event.event_date %}
      <div class="detail-row">
        <span class="label">Event Date:</span>
        <span>{{ event.event_date.strftime('%Y-%m-%d') }}</span>
      </div>
      {% endif %}
      {% if event.closed_date %}
      <div class="detail-row">
        <span class="label">Closed Date:</span>
        <span>{{ event.closed_date.strftime('%Y-%m-%d') }}</span>
      </div>
      {% endif %}
      <div class="detail-row">
        <span class="label">Created:</span>
        <span>{{ event.created_at }}</span>
      </div>
    </div>

    <!-- Malware Section -->
    <div class="content-section">
      <div class="toolbar">
        <h3>Malware ({{ event.malware_instances|length }})</h3>
        <a href="/events/{{ event.id }}/malware/new/form" class="btn-small btn-primary">+ Add Malware</a>
      </div>
      {% if event.malware_instances %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Family</th>
            <th>IOCs</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for malware in event.malware_instances %}
          {% if malware.id %}
          <tr>
            <td>{{ malware.name }}</td>
            <td>{{ malware.family_ref.name if malware.family_ref else (malware.family or '—') }}</td>
            <td>{{ malware.iocs|length }}</td>
            <td class="actions">
              <a href="/malware/{{ malware.id }}/ioc/new/form" class="btn-small">+ IOC</a>
              <a href="/malware/{{ malware.id }}/edit" class="btn-small">Edit</a>
              <form method="post" action="/malware/{{ malware.id }}/delete" style="display:inline">
                <button type="submit" class="btn-small btn-danger" onclick="return confirm('Delete?')">Del</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr style="opacity: 0.5;">
            <td colspan="4" style="color: red; font-weight: bold;">⚠️ Corrupted record (no ID): {{ malware.name or 'Unknown' }}</td>
          </tr>
          {% endif %}
          {% if malware.iocs %}
          <tr>
            <td colspan="4" style="padding-left:40px">
              <strong>IOCs:</strong>
              <ul class="ioc-list">
                {% for ioc in malware.iocs %}
                <li>
                  <span class="badge">{{ ioc.type }}</span> {{ ioc.value }} 
                  <form method="post" action="/ioc/{{ ioc.id }}/delete" style="display:inline">
                    <button type="submit" class="btn-tiny btn-danger" onclick="return confirm('Delete?')">✕</button>
                  </form>
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">No malware linked. <a href="/events/{{ event.id }}/malware/new/form">Add one</a>.</p>
      {% endif %}
    </div>

    <!-- Phishing Section -->
    <div class="content-section">
      <div class="toolbar">
        <h3>Phishing ({{ event.phishing_instances|length }})</h3>
        <a href="/events/{{ event.id }}/phish/new/form" class="btn-small btn-primary">+ Add Phishing</a>
      </div>
      {% if event.phishing_instances %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Sender</th>
            <th>Target</th>
            <th>IOCs</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for phish in event.phishing_instances %}
          {% if phish.id %}
          <tr>
            <td>{{ phish.subject or '—' }}</td>
            <td>{{ phish.sender or '—' }}</td>
            <td>{{ phish.target or '—' }}</td>
            <td>{{ phish.iocs|length }}</td>
            <td class="actions">
              <a href="/phish/{{ phish.id }}/ioc/new/form" class="btn-small">+ IOC</a>
              <a href="/phish/{{ phish.id }}/edit" class="btn-small">Edit</a>
              <form method="post" action="/phish/{{ phish.id }}/delete" style="display:inline">
                <button type="submit" class="btn-small btn-danger" onclick="return confirm('Delete?')">Del</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr style="opacity: 0.5;">
            <td colspan="5" style="color: red; font-weight: bold;">⚠️ Corrupted record (no ID): {{ phish.subject or 'Unknown' }}</td>
          </tr>
          {% endif %}
          {% if phish.iocs %}
          <tr>
            <td colspan="5" style="padding-left:40px">
              <strong>IOCs:</strong>
              <ul class="ioc-list">
                {% for ioc in phish.iocs %}
                <li>
                  <span class="badge">{{ ioc.type }}</span> {{ ioc.value }}
                  <form method="post" action="/ioc/{{ ioc.id }}/delete" style="display:inline">
                    <button type="submit" class="btn-tiny btn-danger" onclick="return confirm('Delete?')">✕</button>
                  </form>
                </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">No phishing linked. <a href="/events/{{ event.id }}/phish/new/form">Add one</a>.</p>
      {% endif %}
    </div>

    <!-- Mitigations Section -->
    <div class="content-section">
      <div class="toolbar">
        <h3>Mitigations ({{ event.mitigations|length }})</h3>
        <a href="/events/{{ event.id }}/mitigation/new/form" class="btn-small btn-primary">+ Add Mitigation</a>
      </div>
      {% if event.mitigations %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for mitigation in event.mitigations %}
          <tr>
            <td>{{ mitigation.title }}</td>
            <td>{{ mitigation.assigned_to or '—' }}</td>
            <td class="actions">
              <a href="/mitigation/{{ mitigation.id }}/edit" class="btn-small">Edit</a>
              <form method="post" action="/mitigation/{{ mitigation.id }}/delete" style="display:inline">
                <button type="submit" class="btn-small btn-danger" onclick="return confirm('Delete?')">Del</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">No mitigations yet. <a href="/events/{{ event.id }}/mitigation/new/form">Add one</a>.</p>
      {% endif %}
    </div>

    <!-- Vulnerabilities Section -->
    <div class="content-section">
      <div class="toolbar">
        <h3>Vulnerabilities ({{ event.vulnerability_instances|length }})</h3>
        <a href="/events/{{ event.id }}/vulnerability/new/form" class="btn-small btn-primary">+ Add Vulnerability</a>
      </div>
      {% if event.vulnerability_instances %}
      <table class="data-table">
        <thead>
          <tr>
            <th>CVE</th>
            <th>Title</th>
            <th>Severity</th>
            <th>CVSS</th>
            <th>Product</th>
            <th>Patch</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for vuln in event.vulnerability_instances %}
          <tr>
            <td>{{ vuln.cve_id or '—' }}</td>
            <td><strong>{{ vuln.title }}</strong></td>
            <td>
              {% if vuln.severity %}
              <span class="badge badge-{{ vuln.severity }}">{{ vuln.severity|upper }}</span>
              {% else %}—{% endif %}
            </td>
            <td>{{ vuln.cvss_score or '—' }}</td>
            <td>{{ vuln.affected_product or '—' }}</td>
            <td>{% if vuln.patch_available %}✓{% else %}✗{% endif %}</td>
            <td class="actions">
              <a href="/vulnerabilities/{{ vuln.id }}/edit" class="btn-small">Edit</a>
              <form method="post" action="/vulnerabilities/{{ vuln.id }}/delete" style="display:inline">
                <button type="submit" class="btn-small btn-danger" onclick="return confirm('Delete?')">Del</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="muted">No vulnerabilities linked. <a href="/events/{{ event.id }}/vulnerability/new/form">Add one</a>.</p>
      {% endif %}
    </div>
  </main>

  <footer>
    <p class="muted"><a href="/events">← Back to Events</a></p>
  </footer>
</body>
</html>
