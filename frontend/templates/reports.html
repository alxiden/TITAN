<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>TITAN ‚Äî Reports</h1>
        <p class="muted">Database: {{ db_path }}</p>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <a href="/" class="btn">üè† Home</a>
        <a href="/settings" class="btn">‚öôÔ∏è Settings</a>
      </div>
    </div>
  </header>

  <main>
    <div class="container-fluid">
      <!-- Custom Report Generator Section -->
      <section class="mb-5" style="background-color: #1e1e2e; border-radius: 8px; padding: 2rem;">
        <h2>Generate Custom Report</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
          
          <!-- Audience Selection -->
          <div>
            <label for="audienceSelect" class="form-label">Target Audience</label>
            <select id="audienceSelect" class="form-select">
              <option value="">-- Select Audience --</option>
              <option value="exec">Executive Leadership</option>
              <option value="it">IT/Technical Team</option>
              <option value="users">End Users</option>
            </select>
          </div>
          
          <!-- Time Period Selection -->
          <div>
            <label for="timePeriodSelect" class="form-label">Report Period</label>
            <select id="timePeriodSelect" class="form-select">
              <option value="">-- Select Period --</option>
              <option value="month">Month</option>
              <option value="quarter">Quarter</option>
              <option value="year">Year</option>
            </select>
          </div>
          
          <!-- Month Selector (hidden by default) -->
          <div id="monthSelectorDiv" style="display: none;">
            <label for="monthSelect" class="form-label">Select Month</label>
            <select id="monthSelect" class="form-select">
              <option value="">-- Select Month --</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          
          <!-- Year Selector (hidden by default) -->
          <div id="yearSelectorDiv" style="display: none;">
            <label for="yearSelect" class="form-label">Select Year</label>
            <select id="yearSelect" class="form-select">
              <option value="">-- Select Year --</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          
          <!-- Quarter Selector (hidden by default) -->
          <div id="quarterSelectorDiv" style="display: none;">
            <label for="quarterSelect" class="form-label">Select Quarter</label>
            <select id="quarterSelect" class="form-select">
              <option value="">-- Select Quarter --</option>
              <option value="Q1">Q1 (Jan-Mar)</option>
              <option value="Q2">Q2 (Apr-Jun)</option>
              <option value="Q3">Q3 (Jul-Sep)</option>
              <option value="Q4">Q4 (Oct-Dec)</option>
            </select>
          </div>
          
          <!-- Generate Button -->
          <div style="display: flex; align-items: flex-end;">
            <button id="generateReportBtn" class="btn btn-primary w-100" style="height: 38px;">
              üìã Generate Report
            </button>
          </div>
        </div>
        
        <!-- Report Output Area -->
        <div id="reportOutput" style="display: none; margin-top: 2rem; background-color: #0d1117; padding: 1.5rem; border-radius: 6px; border-left: 4px solid #1a73e8;">
          <div id="reportContent"></div>
          <button id="downloadReportBtn" class="btn btn-sm btn-outline-light mt-3">
            üì• Download as HTML
          </button>
        </div>
      </section>

      <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Reports</h2>
          <div class="d-flex gap-2 align-items-center">
            <label class="muted" for="startDate">Start:</label>
            <input type="date" id="startDate" class="form-control form-control-sm" style="width:auto;">
            <label class="muted" for="endDate">End:</label>
            <input type="date" id="endDate" class="form-control form-control-sm" style="width:auto;">
            <button class="btn btn-sm" id="applyRange">Apply</button>
          </div>
        </div>

        <!-- Row 1: Phishing -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Phishing Over Time</h3>
              <canvas id="phishOverTimeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Sender Domains</h3>
              <canvas id="phishSenderChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Targets</h3>
              <canvas id="phishTargetChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 2: Malware -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Malware Over Time</h3>
              <canvas id="malwareOverTimeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Malware Families</h3>
              <canvas id="malwareFamilyChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Active Malware</h3>
              <canvas id="malwareLinkageChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 3: Events -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Events Closed Over Time</h3>
              <canvas id="eventsClosedChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Status by Type</h3>
              <canvas id="statusByTypeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Severity Distribution</h3>
              <canvas id="severityChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-5">
        <h2>Recent Events</h2>
        <div class="table-responsive">
          <table class="table table-dark table-striped data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="recentEventsBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="muted">¬© TITAN CTI Platform</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const charts = {};

    function renderEventsClosed(suffix) {
      fetch(`/api/charts/events-closed-timeline${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsClosed) charts.eventsClosed.destroy();
          charts.eventsClosed = new Chart(document.getElementById('eventsClosedChart'), {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{ label: 'Closed', data: data.data, borderColor: '#1e8e3e', backgroundColor: 'rgba(30,142,62,0.2)', tension: 0.3, fill: true }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: '#e6e6e6' } } },
              scales: { x: { ticks: { color: '#9aa0a6' }, grid: { color: '#222431' } }, y: { ticks: { color: '#9aa0a6' }, grid: { color: '#222431' } } }
            }
          });
        });
    }

    function renderStatusByType(suffix) {
      fetch(`/api/charts/status-by-type${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.statusByType) charts.statusByType.destroy();
          charts.statusByType = new Chart(document.getElementById('statusByTypeChart'), {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: data.datasets.map((ds, idx) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: ['#d93025','#f9ab00','#1e8e3e'][idx]
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
            }
          });
        });
    }

    function renderSeverity(suffix) {
      fetch(`/api/charts/event-severity-distribution${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.severity) charts.severity.destroy();
          charts.severity = new Chart(document.getElementById('severityChart'), {
            type: 'doughnut',
            data: {
              labels: data.labels,
              datasets: [{ data: data.data, backgroundColor: ['#8e24aa','#d93025','#f9ab00','#1e8e3e','#9ca3af'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e6e6e6' } } } }
          });
        });
    }

    function renderEventsTypes(suffix) {
      fetch(`/api/charts/events-types-30days${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsTypes) charts.eventsTypes.destroy();
          charts.eventsTypes = new Chart(document.getElementById('eventsTypesChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Events', data: data.data, backgroundColor: ['#1a73e8','#d93025','#f9ab00','#1e8e3e','#8e24aa','#4da6ff','#9ca3af'] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderEventsStart(suffix) {
      fetch(`/api/charts/events-by-start-date${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsStart) charts.eventsStart.destroy();
          charts.eventsStart = new Chart(document.getElementById('eventsStartChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Events', data: data.data, borderColor: '#4da6ff', backgroundColor: 'rgba(77,166,255,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderMalwarePhish(suffix) {
      fetch(`/api/charts/malware-phish-30days${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwarePhish) charts.malwarePhish.destroy();
          charts.malwarePhish = new Chart(document.getElementById('malwarePhishChart'), {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [
                { label: 'Malware', data: data.malware, borderColor: '#1a73e8', backgroundColor: 'rgba(26,115,232,0.2)', tension: 0.3, fill: true },
                { label: 'Phishing', data: data.phishing, borderColor: '#d93025', backgroundColor: 'rgba(217,48,37,0.2)', tension: 0.3, fill: true }
              ]
            },
            options: { responsive: true, plugins: { legend: { labels: { color: '#e6e6e6' } } } }
          });
        });
    }

    function renderRecentEvents(suffix) {
      fetch(`/api/reports/recent-events${suffix}`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('recentEventsBody');
          tbody.innerHTML = '';
          data.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.date}</td><td>${item.title}</td><td><span class="badge">${item.type}</span></td><td>${item.severity}</td><td>${item.status}</td>`;
            tbody.appendChild(tr);
          });
        });
    }

    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const applyBtn = document.getElementById('applyRange');

    function getParams() {
      const start = startInput.value;
      const end = endInput.value;
      const qp = new URLSearchParams();
      if (start) qp.append('start', start);
      if (end) qp.append('end', end);
      return qp.toString();
    }

    function loadAll() {
      const params = getParams();
      const suffix = params ? `?${params}` : '';
      // Phishing
      renderPhishOverTime(suffix);
      renderPhishSender(suffix);
      renderPhishTarget(suffix);
      // Malware
      renderMalwareOverTime(suffix);
      renderMalwareFamily(suffix);
      renderMalwareLinkage(suffix);
      // Events
      renderEventsClosed(suffix);
      renderStatusByType(suffix);
      renderSeverity(suffix);
      // Recent
      renderRecentEvents(suffix);
    }

    applyBtn.addEventListener('click', loadAll);

    // Initialize with last 30 days
    const today = new Date();
    const past = new Date();
    past.setDate(today.getDate() - 30);
    const fmt = d => d.toISOString().slice(0,10);
    startInput.value = fmt(past);
    endInput.value = fmt(today);
    loadAll();

    // Renderers for new charts
    function renderPhishOverTime(suffix) {
      fetch(`/api/charts/phish-over-time${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishOverTime) charts.phishOverTime.destroy();
          charts.phishOverTime = new Chart(document.getElementById('phishOverTimeChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Phishing', data: data.data, borderColor: '#d93025', backgroundColor: 'rgba(217,48,37,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderPhishSender(suffix) {
      fetch(`/api/charts/phish-by-sender-domain${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishSender) charts.phishSender.destroy();
          charts.phishSender = new Chart(document.getElementById('phishSenderChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#1a73e8' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderPhishTarget(suffix) {
      fetch(`/api/charts/phish-by-target${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishTarget) charts.phishTarget.destroy();
          charts.phishTarget = new Chart(document.getElementById('phishTargetChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#4da6ff' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderMalwareOverTime(suffix) {
      fetch(`/api/charts/malware-over-time${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareOverTime) charts.malwareOverTime.destroy();
          charts.malwareOverTime = new Chart(document.getElementById('malwareOverTimeChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Malware', data: data.data, borderColor: '#1a73e8', backgroundColor: 'rgba(26,115,232,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderMalwareFamily(suffix) {
      fetch(`/api/charts/malware-by-family${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareFamily) charts.malwareFamily.destroy();
          charts.malwareFamily = new Chart(document.getElementById('malwareFamilyChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#8e24aa' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderMalwareLinkage(suffix) {
      fetch(`/api/charts/malware-by-linkage${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareLinkage) charts.malwareLinkage.destroy();
          charts.malwareLinkage = new Chart(document.getElementById('malwareLinkageChart'), {
            type: 'doughnut',
            data: { labels: data.labels, datasets: [{ data: data.data, backgroundColor: ['#d93025','#4da6ff'] }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    // Custom Report Generator
    const audienceSelect = document.getElementById('audienceSelect');
    const timePeriodSelect = document.getElementById('timePeriodSelect');
    const monthSelectorDiv = document.getElementById('monthSelectorDiv');
    const yearSelectorDiv = document.getElementById('yearSelectorDiv');
    const quarterSelectorDiv = document.getElementById('quarterSelectorDiv');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const quarterSelect = document.getElementById('quarterSelect');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const reportOutput = document.getElementById('reportOutput');
    const reportContent = document.getElementById('reportContent');
    const downloadReportBtn = document.getElementById('downloadReportBtn');

    // Handle period type selection to show/hide relevant selectors
    timePeriodSelect.addEventListener('change', function() {
      monthSelectorDiv.style.display = 'none';
      yearSelectorDiv.style.display = 'none';
      quarterSelectorDiv.style.display = 'none';
      
      if (this.value === 'month') {
        monthSelectorDiv.style.display = 'block';
      } else if (this.value === 'year') {
        yearSelectorDiv.style.display = 'block';
      } else if (this.value === 'quarter') {
        quarterSelectorDiv.style.display = 'block';
      }
    });

    generateReportBtn.addEventListener('click', async function() {
      const audience = audienceSelect.value;
      const periodType = timePeriodSelect.value;
      
      let period = null;
      let periodLabel = '';
      
      if (periodType === 'month') {
        period = monthSelect.value;
        const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        periodLabel = monthNames[parseInt(period)] || period;
      } else if (periodType === 'quarter') {
        period = quarterSelect.value;
        periodLabel = period;
      } else if (periodType === 'year') {
        period = yearSelect.value;
        periodLabel = period;
      }

      if (!audience || !periodType || !period) {
        alert('Please select audience, period type, and the specific period.');
        return;
      }

      generateReportBtn.disabled = true;
      generateReportBtn.textContent = '‚è≥ Generating...';

      try {
        const response = await fetch(`/api/reports/generate?audience=${audience}&period_type=${periodType}&period=${period}`);
        const data = await response.json();

        if (response.ok) {
          reportContent.innerHTML = data.html;
          reportOutput.style.display = 'block';
          document.querySelector('section').scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('Error generating report: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        generateReportBtn.disabled = false;
        generateReportBtn.textContent = 'üìã Generate Report';
      }
    });

    downloadReportBtn.addEventListener('click', function() {
      const audience = audienceSelect.value;
      const periodType = timePeriodSelect.value;
      let period = null;
      
      if (periodType === 'month') {
        period = monthSelect.value;
      } else if (periodType === 'quarter') {
        period = quarterSelect.value;
      } else if (periodType === 'year') {
        period = yearSelect.value;
      }
      
      const timestamp = new Date().toISOString().slice(0,10);
      
      const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TITAN Report - ${audience} - ${period}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #ffffff; color: #333; font-family: Arial, sans-serif; }
    h1, h2, h3 { color: #1a73e8; margin-top: 1.5rem; margin-bottom: 0.75rem; }
    .report-header { background-color: #f0f4f9; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #1a73e8; }
    .metric { display: inline-block; margin-right: 2rem; padding: 0.75rem 0; }
    .metric-value { font-size: 1.5rem; font-weight: bold; color: #1a73e8; }
    .metric-label { font-size: 0.875rem; color: #666; text-transform: uppercase; }
    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    th { background-color: #1a73e8; color: white; padding: 0.75rem; text-align: left; }
    td { padding: 0.75rem; border-bottom: 1px solid #e0e0e0; }
    .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e0e0e0; color: #666; font-size: 0.875rem; }
  </style>
</head>
<body>
  ${reportContent.innerHTML}
  <div class="footer">
    <p>Report Generated: ${new Date().toLocaleString()}</p>
    <p>TITAN CTI Platform</p>
  </div>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `TITAN_Report_${audience}_${period}_${timestamp}.html`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      a.remove();
    });
  </script>
</body>
</html>