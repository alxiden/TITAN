<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>TITAN ‚Äî Reports</h1>
        <p class="muted">Database: {{ db_path }}</p>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <a href="/" class="btn">üè† Home</a>
        <a href="/settings" class="btn">‚öôÔ∏è Settings</a>
      </div>
    </div>
  </header>

  <main>
    <div class="container-fluid">
      <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Reports</h2>
          <div class="d-flex gap-2 align-items-center">
            <label class="muted" for="startDate">Start:</label>
            <input type="date" id="startDate" class="form-control form-control-sm" style="width:auto;">
            <label class="muted" for="endDate">End:</label>
            <input type="date" id="endDate" class="form-control form-control-sm" style="width:auto;">
            <button class="btn btn-sm" id="applyRange">Apply</button>
          </div>
        </div>

        <!-- Row 1: Phishing -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Phishing Over Time</h3>
              <canvas id="phishOverTimeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Sender Domains</h3>
              <canvas id="phishSenderChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Targets</h3>
              <canvas id="phishTargetChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 2: Malware -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Malware Over Time</h3>
              <canvas id="malwareOverTimeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Top Malware Families</h3>
              <canvas id="malwareFamilyChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Active Malware</h3>
              <canvas id="malwareLinkageChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 3: Events -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Events Closed Over Time</h3>
              <canvas id="eventsClosedChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Status by Type</h3>
              <canvas id="statusByTypeChart"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="chart-container">
              <h3>Severity Distribution</h3>
              <canvas id="severityChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="mt-5">
        <h2>Recent Events</h2>
        <div class="table-responsive">
          <table class="table table-dark table-striped data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="recentEventsBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <p class="muted">¬© TITAN CTI Platform</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const charts = {};

    function renderEventsClosed(suffix) {
      fetch(`/api/charts/events-closed-timeline${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsClosed) charts.eventsClosed.destroy();
          charts.eventsClosed = new Chart(document.getElementById('eventsClosedChart'), {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{ label: 'Closed', data: data.data, borderColor: '#1e8e3e', backgroundColor: 'rgba(30,142,62,0.2)', tension: 0.3, fill: true }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { labels: { color: '#e6e6e6' } } },
              scales: { x: { ticks: { color: '#9aa0a6' }, grid: { color: '#222431' } }, y: { ticks: { color: '#9aa0a6' }, grid: { color: '#222431' } } }
            }
          });
        });
    }

    function renderStatusByType(suffix) {
      fetch(`/api/charts/status-by-type${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.statusByType) charts.statusByType.destroy();
          charts.statusByType = new Chart(document.getElementById('statusByTypeChart'), {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: data.datasets.map((ds, idx) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: ['#d93025','#f9ab00','#1e8e3e'][idx]
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
            }
          });
        });
    }

    function renderSeverity(suffix) {
      fetch(`/api/charts/event-severity-distribution${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.severity) charts.severity.destroy();
          charts.severity = new Chart(document.getElementById('severityChart'), {
            type: 'doughnut',
            data: {
              labels: data.labels,
              datasets: [{ data: data.data, backgroundColor: ['#8e24aa','#d93025','#f9ab00','#1e8e3e','#9ca3af'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e6e6e6' } } } }
          });
        });
    }

    function renderEventsTypes(suffix) {
      fetch(`/api/charts/events-types-30days${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsTypes) charts.eventsTypes.destroy();
          charts.eventsTypes = new Chart(document.getElementById('eventsTypesChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Events', data: data.data, backgroundColor: ['#1a73e8','#d93025','#f9ab00','#1e8e3e','#8e24aa','#4da6ff','#9ca3af'] }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderEventsStart(suffix) {
      fetch(`/api/charts/events-by-start-date${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.eventsStart) charts.eventsStart.destroy();
          charts.eventsStart = new Chart(document.getElementById('eventsStartChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Events', data: data.data, borderColor: '#4da6ff', backgroundColor: 'rgba(77,166,255,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderMalwarePhish(suffix) {
      fetch(`/api/charts/malware-phish-30days${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwarePhish) charts.malwarePhish.destroy();
          charts.malwarePhish = new Chart(document.getElementById('malwarePhishChart'), {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [
                { label: 'Malware', data: data.malware, borderColor: '#1a73e8', backgroundColor: 'rgba(26,115,232,0.2)', tension: 0.3, fill: true },
                { label: 'Phishing', data: data.phishing, borderColor: '#d93025', backgroundColor: 'rgba(217,48,37,0.2)', tension: 0.3, fill: true }
              ]
            },
            options: { responsive: true, plugins: { legend: { labels: { color: '#e6e6e6' } } } }
          });
        });
    }

    function renderRecentEvents(suffix) {
      fetch(`/api/reports/recent-events${suffix}`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('recentEventsBody');
          tbody.innerHTML = '';
          data.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.date}</td><td>${item.title}</td><td><span class="badge">${item.type}</span></td><td>${item.severity}</td><td>${item.status}</td>`;
            tbody.appendChild(tr);
          });
        });
    }

    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const applyBtn = document.getElementById('applyRange');

    function getParams() {
      const start = startInput.value;
      const end = endInput.value;
      const qp = new URLSearchParams();
      if (start) qp.append('start', start);
      if (end) qp.append('end', end);
      return qp.toString();
    }

    function loadAll() {
      const params = getParams();
      const suffix = params ? `?${params}` : '';
      // Phishing
      renderPhishOverTime(suffix);
      renderPhishSender(suffix);
      renderPhishTarget(suffix);
      // Malware
      renderMalwareOverTime(suffix);
      renderMalwareFamily(suffix);
      renderMalwareLinkage(suffix);
      // Events
      renderEventsClosed(suffix);
      renderStatusByType(suffix);
      renderSeverity(suffix);
      // Recent
      renderRecentEvents(suffix);
    }

    applyBtn.addEventListener('click', loadAll);

    // Initialize with last 30 days
    const today = new Date();
    const past = new Date();
    past.setDate(today.getDate() - 30);
    const fmt = d => d.toISOString().slice(0,10);
    startInput.value = fmt(past);
    endInput.value = fmt(today);
    loadAll();

    // Renderers for new charts
    function renderPhishOverTime(suffix) {
      fetch(`/api/charts/phish-over-time${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishOverTime) charts.phishOverTime.destroy();
          charts.phishOverTime = new Chart(document.getElementById('phishOverTimeChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Phishing', data: data.data, borderColor: '#d93025', backgroundColor: 'rgba(217,48,37,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderPhishSender(suffix) {
      fetch(`/api/charts/phish-by-sender-domain${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishSender) charts.phishSender.destroy();
          charts.phishSender = new Chart(document.getElementById('phishSenderChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#1a73e8' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderPhishTarget(suffix) {
      fetch(`/api/charts/phish-by-target${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.phishTarget) charts.phishTarget.destroy();
          charts.phishTarget = new Chart(document.getElementById('phishTargetChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#4da6ff' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderMalwareOverTime(suffix) {
      fetch(`/api/charts/malware-over-time${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareOverTime) charts.malwareOverTime.destroy();
          charts.malwareOverTime = new Chart(document.getElementById('malwareOverTimeChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: [{ label: 'Malware', data: data.data, borderColor: '#1a73e8', backgroundColor: 'rgba(26,115,232,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }

    function renderMalwareFamily(suffix) {
      fetch(`/api/charts/malware-by-family${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareFamily) charts.malwareFamily.destroy();
          charts.malwareFamily = new Chart(document.getElementById('malwareFamilyChart'), {
            type: 'bar',
            data: { labels: data.labels, datasets: [{ label: 'Count', data: data.data, backgroundColor: '#8e24aa' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
          });
        });
    }

    function renderMalwareLinkage(suffix) {
      fetch(`/api/charts/malware-by-linkage${suffix}`)
        .then(res => res.json())
        .then(data => {
          if (charts.malwareLinkage) charts.malwareLinkage.destroy();
          charts.malwareLinkage = new Chart(document.getElementById('malwareLinkageChart'), {
            type: 'doughnut',
            data: { labels: data.labels, datasets: [{ data: data.data, backgroundColor: ['#d93025','#4da6ff'] }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
        });
    }
  </script>
</body>
</html>